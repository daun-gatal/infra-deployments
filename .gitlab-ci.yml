stages:
  - build
  - validate
  - plan
  - execute

include:
  - local: 'deployments/database/.gitlab-ci.yml'
  - local: 'deployments/minio/.gitlab-ci.yml'
  - local: 'deployments/kafka/.gitlab-ci.yml'
  - local: 'deployments/trino/.gitlab-ci.yml'
  - local: 'deployments/metabase/.gitlab-ci.yml'
  - local: 'deployments/airflow/.gitlab-ci.yml'
  - local: 'deployments/openbao/.gitlab-ci.yml'
  - local: 'deployments/superset/.gitlab-ci.yml'
  - local: 'deployments/airbyte/.gitlab-ci.yml'
  - local: 'deployments/keycloak/.gitlab-ci.yml'

# ==========================================================
# Docker Image Build
# ==========================================================
build docker:
  stage: build
  image: docker:27
  services:
    - name: docker:27-dind
      command: ["--tls=false"]
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - |
      # Calculate hash of Dockerfile to use as unique tag
      DOCKERFILE_HASH=$(md5sum docker/Dockerfile | awk '{ print $1 }')
      IMAGE_TAG="$CI_REGISTRY_IMAGE/terraform-runner:$DOCKERFILE_HASH"
      IMAGE_LATEST="$CI_REGISTRY_IMAGE/terraform-runner:latest"

      echo "Checking if image $IMAGE_TAG exists..."
      
      if docker manifest inspect $IMAGE_TAG > /dev/null 2>&1; then
        echo "‚úÖ Image $IMAGE_TAG already exists. Skipping build."
        echo "üîÑ Updating 'latest' tag..."
        docker pull $IMAGE_TAG
        docker tag $IMAGE_TAG $IMAGE_LATEST
        docker push $IMAGE_LATEST
      else
        echo "üõ†Ô∏è Image not found. Building..."
        docker build -t $IMAGE_TAG -t $IMAGE_LATEST docker/
        docker push $IMAGE_TAG
        docker push $IMAGE_LATEST
      fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      changes:
        - "docker/Dockerfile"
      when: always
      allow_failure: true
    - when: manual
      allow_failure: true
  tags:
    - k8s

# Add comments to the jobs below as needed v1