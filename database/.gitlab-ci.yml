stages:
  - plan
  - apply

variables:
  MODULE_DIR: "database"
  REMOTE_DIR: "/opt/terraform-deploy"
  OUTPUT_DIR: "/opt/terraform-outputs"
  TAILSCALE_HOSTNAME: "ci-runner-${CI_PROJECT_NAME}-${CI_PIPELINE_ID}"
  TF_USERNAME: "${GITLAB_USERNAME}"
  TF_PASSWORD: "${CI_JOB_TOKEN}"

# ==========================================================
# Global setup for Tailscale - runs before every job
# ==========================================================
before_script:
  - apt-get update && apt-get install -y curl openssh-client
  - curl -fsSL https://tailscale.com/install.sh | sh
  - nohup tailscaled & 
  - sleep 5  # Wait for tailscaled to start

# ==========================================================
# Terraform PLAN for Database Module
# ==========================================================
database_plan:
  stage: plan
  image: ubuntu:22.04
  rules:
    - changes:
        - "database/**"
      when: always
    - when: never
  script:
    - |
      cat > ${MODULE_DIR}/backend.hcl <<EOF
      address         = "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${MODULE_DIR}"
      lock_address    = "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${MODULE_DIR}/lock"
      unlock_address  = "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${MODULE_DIR}/lock"
      lock_method     = "POST"
      unlock_method   = "DELETE"
      retry_wait_min  = 5
      username        = "${CI_JOB_TOKEN}"
      password        = "${CI_JOB_TOKEN}"
      EOF
      echo "✅ Created backend.hcl for module: ${MODULE_DIR}"

    - tailscale up --auth-key=${TAILSCALE_AUTH_KEY} --hostname=${TAILSCALE_HOSTNAME}

    - ssh -o StrictHostKeyChecking=no root@${TAILSCALE_SERVER} "mkdir -p ${REMOTE_DIR}/${MODULE_DIR} && mkdir -p ${OUTPUT_DIR}/${MODULE_DIR}"
    - scp -o StrictHostKeyChecking=no -r ./${MODULE_DIR} root@${TAILSCALE_SERVER}:${REMOTE_DIR}/
    - echo "✅ Module ${MODULE_DIR} copied to remote server"

    - ssh -o StrictHostKeyChecking=no root@${TAILSCALE_SERVER} "
        cd ${REMOTE_DIR}/${MODULE_DIR} &&
        terraform init -upgrade  -backend-config=backend.hcl &&
        terraform plan -var="db_password=${DB_PASSWORD}"
      "
    - echo "✅ Terraform plan saved to ${OUTPUT_DIR}/${MODULE_DIR}/plan.tfplan"

    - tailscale logout # Logout to avoid leaking auth key on remote server

# ==========================================================
# Terraform APPLY for Database Module
# ==========================================================
database_apply:
  stage: apply
  image: ubuntu:22.04
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      changes:
        - "database/**"
      when: always
    - when: never
  script:
    - tailscale up --auth-key=${TAILSCALE_AUTH_KEY} --hostname=${TAILSCALE_HOSTNAME}
    - ssh -o StrictHostKeyChecking=no root@${TAILSCALE_SERVER} "
        cd ${REMOTE_DIR}/${MODULE_DIR} &&
        terraform apply -auto-approve -var="db_password=${DB_PASSWORD}"  &&
        terraform output -json > ${OUTPUT_DIR}/${MODULE_DIR}/outputs.json
      "
    - tailscale logout # Logout to avoid leaking auth key on remote server
    