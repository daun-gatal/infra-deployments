stages:
  - plan
  - apply

variables:
  MODULE_DIR: "database"
  REMOTE_DIR: "/opt/terraform-deploy"
  OUTPUT_DIR: "/opt/terraform-outputs"
  TAILSCALE_HOSTNAME: "ci-runner-${CI_PROJECT_NAME}-${CI_PIPELINE_ID}"

# ==========================================================
# Global setup for Tailscale - runs before every job
# ==========================================================
before_script:
  - apt-get update && apt-get install -y curl openssh-client
  - curl -fsSL https://tailscale.com/install.sh | sh
  - nohup tailscaled & 
  - sleep 5  # Wait for tailscaled to start
  - tailscale up --auth-key=${TAILSCALE_AUTH_KEY} --hostname=${TAILSCALE_HOSTNAME}
  - echo "✅ Connected to Tailscale as ${TAILSCALE_HOSTNAME}"

# ==========================================================
# Terraform PLAN for Database Module
# ==========================================================
database_plan:
  stage: plan
  image: ubuntu:22.04
  rules:
    - changes:
        - "database/**"
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      when: always
    - when: never
  script:
    - ssh -o StrictHostKeyChecking=no root@${TAILSCALE_SERVER} "mkdir -p ${REMOTE_DIR}/${MODULE_DIR} && mkdir -p ${OUTPUT_DIR}/${MODULE_DIR}"
    - scp -o StrictHostKeyChecking=no -r ./${MODULE_DIR} root@${TAILSCALE_SERVER}:${REMOTE_DIR}/
    - echo "✅ Module ${MODULE_DIR} copied to remote server"
    - ssh -o StrictHostKeyChecking=no root@${TAILSCALE_SERVER} "
        cd ${REMOTE_DIR}/${MODULE_DIR} &&
        rm -rf .terraform .terraform.lock.hcl &&
        terraform init --upgrade &&
        terraform plan -out=${OUTPUT_DIR}/${MODULE_DIR}/plan.tfplan -var="db_password=${DB_PASSWORD}"
      "
    - echo "✅ Terraform plan saved to ${OUTPUT_DIR}/${MODULE_DIR}/plan.tfplan"
    - tailscale logout # Logout to avoid leaking auth key on remote server

# ==========================================================
# Terraform APPLY for Database Module
# ==========================================================
database_apply:
  stage: apply
  image: ubuntu:22.04
  rules:
    - changes:
        - "database/**"
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never
  script:
    - ssh -o StrictHostKeyChecking=no root@${TAILSCALE_SERVER} "
        cd ${REMOTE_DIR}/${MODULE_DIR} &&
        terraform apply ${OUTPUT_DIR}/${MODULE_DIR}/plan.tfplan -auto-approve -var="db_password=${DB_PASSWORD}" -state=${OUTPUT_DIR}/${MODULE_DIR}/terraform.tfstate &&
        terraform output -state=${OUTPUT_DIR}/${MODULE_DIR}/terraform.tfstate -json > ${OUTPUT_DIR}/${MODULE_DIR}/outputs.json
      "
    - tailscale logout # Logout to avoid leaking auth key on remote server
    