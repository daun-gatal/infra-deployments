variables:
  PORT_NUMBERS:
    value: "8080"
    description: "Port number to expose (e.g., 8080). Comma separated list of ports."

include:
  - local: 'ci-templates/deploy-build.yml'

# ==========================================================
# Terraform VALIDATE for Dockge Module
# ==========================================================
dockge (validate):
  extends: .validate_template
  variables:
    MODULE_NAME: deployments/dockge

# ==========================================================
# Terraform PLAN for Dockge Module
# ==========================================================
dockge (plan):
  extends: .plan_template
  needs: ["dockge (validate)"]
  variables:
    MODULE_NAME: deployments/dockge

# ==========================================================
# Terraform APPLY for Dockge Module
# ==========================================================
dockge:
  extends: .apply_template
  parallel:
    matrix:
      - TF_ACTION: [apply, refresh, destroy]
  variables:
    MODULE_NAME: deployments/dockge
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[auto-apply\]/ && $CI_COMMIT_BRANCH == "main" && $TF_ACTION == "apply"'
      when: on_success
      variables:
        IGNORE_PLAN: "true"
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      changes:
        - "${MODULE_NAME}/main.tf"  
      when: manual
    - when: never

# ==========================================================
# Add Port to Dockge
# ==========================================================
dockge-add-port:
  stage: execute
  image: alpine:latest
  variables:
    GIT_STRATEGY: clone
  before_script:
    - apk add --no-cache jq git
    - git config --global user.email "ci-bot@gitlab.com"
    - git config --global user.name "CI Bot"
    # Setup remote with credentials (GIT_PUSH_TOKEN is required for protected branches)
    - git remote set-url origin https://oauth2:${GIT_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
  script:
    - |
      if [ -z "$PORT_NUMBERS" ]; then
        echo "âŒ Error: PORT_NUMBERS must be provided."
        exit 1
      fi
      
      echo "Update port configuration with: $PORT_NUMBERS"
      cd deployments/dockge
      
      # Create temp file to avoid atomic write issues
      # Filter OUT existing port (if any), then add new one
      jq --arg ports "$PORT_NUMBERS" '
        ($ports | split(",") | map(gsub("^\\s+|\\s+$"; "") | select(length > 0) | tonumber)) as $new_ports |
        reduce $new_ports[] as $p (.; 
          map(select(.port != $p)) + [{"name": ("port-" + ($p|tostring)), "port": $p}]
        )
      ' templates/ports.json > templates/ports.tmp && mv templates/ports.tmp templates/ports.json
         
      git add templates/ports.json
      
      # Force commit even if no changes, to trigger the pipeline (as requested)
      git commit --allow-empty -m "Update ports: $PORT_NUMBERS [auto-apply]"
      
      # Pull latest main to avoid conflicts
      git pull origin main --rebase
      git push origin HEAD:main
  when: manual

  tags:
    - k8s