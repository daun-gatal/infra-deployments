.validate_template:
  stage: validate
  image: $CI_REGISTRY_IMAGE/terraform-runner:latest
  before_script:
    - chmod +x scripts/ci/setup-env.sh
    - bash scripts/ci/setup-env.sh
    - terraform --version
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      changes:
        - "${MODULE_NAME}/**/*"
  script:
    - cd ${MODULE_NAME}
    # Initialize without backend to avoid lock/auth errors during validation
    - terraform init -backend=false -input=false
    - terraform validate
    - echo "ðŸ” Running TFLint..."
    # Use the root .tflint.hcl config
    - tflint --config=../../.tflint.hcl
    - echo "ðŸ›¡ï¸ Running Trivy..."
    - trivy config . --severity HIGH,CRITICAL --exit-code 0
  tags:
    - k8s

.plan_template:
  stage: plan
  image: $CI_REGISTRY_IMAGE/terraform-runner:latest
  variables:
    KUBECONFIG: "${KUBECONFIG_FILE}"

  before_script:
    - chmod +x scripts/ci/setup-env.sh
    - bash scripts/ci/setup-env.sh

  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      changes:
        - "${MODULE_NAME}/main.tf"
      when: always
    - when: never

  script:
  script:
    - |
      # Use basename (e.g. 'database' from 'deployments/database') to preserve existing state
      STATE_NAME=$(basename ${MODULE_NAME})
      echo "â„¹ï¸  Using state name: ${STATE_NAME}"

      cat > ${MODULE_NAME}/.backend.hcl <<EOF
      address         = "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${STATE_NAME}"
      lock_address    = "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${STATE_NAME}/lock"
      unlock_address  = "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${STATE_NAME}/lock"
      lock_method     = "POST"
      unlock_method   = "DELETE"
      retry_wait_min  = 5
      username        = "${GITLAB_USERNAME}"
      password        = "${GITLAB_TOKEN}"
      EOF
      echo "âœ… Created backend.hcl for module: ${MODULE_NAME}"
    
    - envsubst < .tf.env > ${MODULE_NAME}/.tfvars

    # Run Terraform inside module directory
    - cd ${MODULE_NAME}
    - terraform init -upgrade -backend-config=.backend.hcl
    - terraform plan -var-file=.tfvars -compact-warnings -out=tfplan

  artifacts:
    name: "plan-${MODULE_NAME}"
    paths:
    - ${MODULE_NAME}/tfplan
    - ${MODULE_NAME}/.terraform.lock.hcl
    - ${MODULE_NAME}/.terraform/providers
    expire_in: 1 hour
  tags:
    - k8s

.apply_template:
  stage: execute
  image: $CI_REGISTRY_IMAGE/terraform-runner:latest
  variables:
    KUBECONFIG: "${KUBECONFIG_FILE}"
    OUTPUT_DIR: "/opt/terraform-outputs"
    TF_ACTION: "refresh"
  before_script:
    - chmod +x scripts/ci/setup-env.sh 
    - chmod +x scripts/ci/tailscale-setup.sh
    - chmod +x scripts/ci/download-mr-artifacts.sh
    - chmod +x scripts/ci/terraform-exec.sh
    - bash scripts/ci/setup-env.sh
    - bash scripts/ci/tailscale-setup.sh
    - bash scripts/ci/download-mr-artifacts.sh

  rules:
    # ðŸš« BLOCK DESTROY unless explicitly enabled in GitLab UI
    - if: '$TF_ACTION == "destroy" && $DESTROY_ENABLED != "true"'
      when: never
      
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      changes:
        - "${MODULE_NAME}/main.tf"  
      when: manual
    - when: never

  script:
    - bash scripts/ci/terraform-exec.sh

  after_script:
    - tailscale logout

  tags:
    - k8s