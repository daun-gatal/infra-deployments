.plan_template:
  stage: plan
  image: ubuntu:22.04
  variables:
    KUBECONFIG: "$KUBECONFIG_FILE"
    DB_OUTPUT_DIR: "database"
    MINIO_OUTPUT_DIR: "minio"

  before_script:
    - apt-get update && apt-get install -y curl openssh-client gettext-base gnupg software-properties-common wget

    - wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor > /usr/share/keyrings/hashicorp-archive-keyring.gpg
    - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" > /etc/apt/sources.list.d/hashicorp.list
    - apt-get update
    - apt-get install -y terraform

    - mkdir -p /var/run/tailscale
    - curl -fsSL https://tailscale.com/install.sh | sh
    - "tailscaled --tun=userspace-networking --state=mem: --socket=/var/run/tailscale/tailscaled.sock &"
    - sleep 5
    - tailscale up --auth-key="${TAILSCALE_AUTH_KEY}?preauthorized=true" --accept-routes --hostname="gitlab-runner-${MODULE_NAME}-$(head /dev/urandom | tr -dc a-z0-9 | head -c6)" --advertise-tags=tag:git

  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      changes:
        - "${MODULE_NAME}/main.tf"
      when: always
    - when: never

  script:
    - |
      cat > ${MODULE_NAME}/.backend.hcl <<EOF
      address         = "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${MODULE_NAME}"
      lock_address    = "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${MODULE_NAME}/lock"
      unlock_address  = "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${MODULE_NAME}/lock"
      lock_method     = "POST"
      unlock_method   = "DELETE"
      retry_wait_min  = 5
      username        = "${GITLAB_USERNAME}"
      password        = "${GITLAB_TOKEN}"
      EOF
      echo "âœ… Created backend.hcl for module: ${MODULE_NAME}"
    
    - envsubst < .tf.env > ${MODULE_NAME}/.tfvars

    # Run Terraform inside module directory
    - cd ${MODULE_NAME}
    - terraform init -upgrade -backend-config=.backend.hcl
    - terraform plan -var-file=.tfvars -compact-warnings -out=tfplan

    - tailscale logout
  artifacts:
    name: "plan-${MODULE_NAME}"
    paths:
      - ${MODULE_NAME}/tfplan
    expire_in: 1 hour
  tags:
    - k8s

.apply_template:
  stage: apply
  image: ubuntu:22.04
  variables:
    KUBECONFIG: "$KUBECONFIG_FILE"
    OUTPUT_DIR: "/opt/terraform-outputs"
  before_script:
    - apt-get update && apt-get install -y curl openssh-client gettext-base gnupg software-properties-common wget

    - wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor > /usr/share/keyrings/hashicorp-archive-keyring.gpg
    - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" > /etc/apt/sources.list.d/hashicorp.list
    - apt-get update
    - apt-get install -y terraform

    - mkdir -p /var/run/tailscale
    - curl -fsSL https://tailscale.com/install.sh | sh
    - "tailscaled --tun=userspace-networking --state=mem: --socket=/var/run/tailscale/tailscaled.sock &"
    - sleep 5
    - tailscale up --auth-key="${TAILSCALE_AUTH_KEY}?preauthorized=true" --accept-routes --hostname="gitlab-runner-${MODULE_NAME}-$(head /dev/urandom | tr -dc a-z0-9 | head -c6)" --advertise-tags=tag:git

  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      changes:
        - "${MODULE_NAME}/main.tf"  
      when: manual
    - when: never

  script:
    - cd ${MODULE_NAME}
    - terraform apply -auto-approve -compact-warnings tfplan
    - terraform output -json > outputs.json
    - tailscale ssh root@${TAILSCALE_SERVER} -- "mkdir -p ${OUTPUT_DIR}/${MODULE_NAME} && cat > ${OUTPUT_DIR}/${MODULE_NAME}/outputs.json" < outputs.json

    - tailscale logout
  tags:
    - k8s