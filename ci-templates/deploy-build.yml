.plan_template:
  stage: plan
  image: ubuntu:22.04
  variables:
    REMOTE_DIR: "/opt/terraform-deploy"
    OUTPUT_DIR: "/opt/terraform-outputs"
    TAILSCALE_HOSTNAME: "ci-runner-${CI_PROJECT_NAME}-${CI_PIPELINE_ID}"

  before_script:
    - apt-get update && apt-get install -y curl openssh-client gettext-base

  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      changes:
        - "${MODULE_NAME}/main.tf"
      when: always
    - when: never

  script:
    - |
      cat > ${MODULE_NAME}/backend.hcl <<EOF
      address         = "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${MODULE_NAME}"
      lock_address    = "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${MODULE_NAME}/lock"
      unlock_address  = "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${MODULE_NAME}/lock"
      lock_method     = "POST"
      unlock_method   = "DELETE"
      retry_wait_min  = 5
      username        = "${GITLAB_USERNAME}"
      password        = "${GITLAB_TOKEN}"
      EOF
      echo "✅ Created backend.hcl for module: ${MODULE_NAME}"

    - ssh -o StrictHostKeyChecking=no root@${TAILSCALE_SERVER} "mkdir -p ${REMOTE_DIR}/${MODULE_NAME} && mkdir -p ${OUTPUT_DIR}/${MODULE_NAME}"
    - scp -o StrictHostKeyChecking=no -r ./${MODULE_NAME} root@${TAILSCALE_SERVER}:${REMOTE_DIR}/
    
    - envsubst < .tf.env > .tfvars
    - scp -o StrictHostKeyChecking=no .tfvars root@${TAILSCALE_SERVER}:/opt/.tfvars
    
    - echo "✅ Module ${MODULE_NAME} copied to remote server"

    - ssh -o StrictHostKeyChecking=no root@${TAILSCALE_SERVER} "
        cd ${REMOTE_DIR}/${MODULE_NAME} &&
        terraform init -upgrade -backend-config=backend.hcl -migrate-state &&
        terraform plan -var-file=/opt/.tfvars -compact-warnings
      "
  tags:
    - k8s

.apply_template:
  stage: apply
  image: ubuntu:22.04
  variables:
    REMOTE_DIR: "/opt/terraform-deploy"
    OUTPUT_DIR: "/opt/terraform-outputs"
    TAILSCALE_HOSTNAME: "ci-runner-${CI_PROJECT_NAME}-${CI_PIPELINE_ID}"

  before_script:
    - apt-get update && apt-get install -y curl openssh-client gettext-base

  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      changes:
        - "${MODULE_NAME}/main.tf"
      when: always
    - when: never

  script:
    - ssh -o StrictHostKeyChecking=no root@${TAILSCALE_SERVER} "
        cd ${REMOTE_DIR}/${MODULE_NAME} &&
        terraform apply -var-file=/opt/.tfvars -auto-approve -compact-warnings &&
        terraform output -json > ${OUTPUT_DIR}/${MODULE_NAME}/outputs.json
      "
  tags:
    - k8s